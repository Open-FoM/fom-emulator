# FoM Emulator Log

- [ ] [12/28/25-11:02PM] M1 Transport capture + decision
  - Context: Docs\Projects\Emulator.md (Solution Sketch #1)
  - Acceptance: First login packets captured and transport path confirmed (RakNet vs CUDPDriver).
  - Validation: PCAP + summary attached; decision recorded (magic 0x9919D9C7 vs RakNet IDs).
  - Dependencies: FoM client runnable; SharkMCP (Wireshark/tshark MCP) or emulator logging.
  - Status: In progress. [12/31/25-08:50AM] Added SERVER_MODE (master|world) and world-auth handling for 0x6E; world mode can auto-send initial LithTech protocol/ID packets after auth and queues extra packets. Intended delta: run separate world server instance with shared RakNet plumbing and minimal world handshake. Diff: ServerEmulator/src/handlers/PacketHandler.ts, ServerEmulator/src/login/LoginDecoder.ts, ServerEmulator/src/network/Connection.ts, ServerEmulator/src/index.ts, ServerEmulator/src/config/ConfigLoader.ts, ServerEmulator/fom_server.ini, start_server.bat. Rollback: git checkout -- ServerEmulator/src/handlers/PacketHandler.ts ServerEmulator/src/login/LoginDecoder.ts ServerEmulator/src/network/Connection.ts ServerEmulator/src/index.ts ServerEmulator/src/config/ConfigLoader.ts ServerEmulator/fom_server.ini start_server.bat

- [ ] [12/28/25-11:02PM] M2 Protocol framing alignment (BitStream + constants)
  - Context: Docs\Projects\Emulator.md (Inputs / Facts, Solution Sketch #2)
  - Acceptance: Bit order is MSB-first, compressed ints match FoM, default port aligns with FoM capture.
  - Validation: Unit decode of captured packet; emulator logs show correct parsing with no bit overruns.
  - Tasks: Update BitStream order + endian; implement FoM compressed ints; fix constants and header parsing.
  - Dependencies: M1 decision; AddressMap.md bitstream section.
  - Status: Not started.

- [ ] [12/28/25-11:02PM] M3 Master login path (LOGIN_REQUEST -> 0x6D)
  - Context: Docs\Projects\Emulator.md (Solution Sketch #3)
  - Acceptance: LOGIN_REQUEST parsed from capture; LOGIN_REQUEST_RETURN sent and ACKed.
  - Validation: Emulator logs show login success; client proceeds to world connect; ACK observed.
  - Tasks: Identify LOGIN_REQUEST layout; implement parser; build 0x6D response with world IP/port.
  - Dependencies: M1, M2; capture data for LOGIN_REQUEST layout.
  - Status: In progress. [12/31/25-07:26PM] Added ClientEmulator handling for 0x7B WORLD_SELECT (subId=4) inside reliable packets to set worldId/worldInst/playerId and auto-send 0x72 WORLD_LOGIN to master (gated when configured playerId mismatches); added 0x73 WORLD_LOGIN_RETURN decode to capture world IP/port and retry on code 8; added logger labels for 0x72/0x73/0x7B. Intended delta: client emulator follows the reliable-packet login chain after 0x6E without manual flags, matching CShell handler gating. Diff: ClientEmulator/src/tools/TestClient.ts, ClientEmulator/src/utils/PacketLogger.ts. Rollback: git checkout -- ClientEmulator/src/tools/TestClient.ts ClientEmulator/src/utils/PacketLogger.ts. [12/31/25-07:39PM] Master now emits 0x7B subId=4 after 0x6E and waits for 0x72 WORLD_LOGIN before sending 0x73; parses 0x72 payload (worldId/worldInst/playerId/worldConst) and gates by configured playerId; added 0x7B/0x72/0x73 login markers and constants. Intended delta: align master login flow with CShell (0x7B then 0x72 -> 0x73) using configured worldId/worldInst/playerId/worldConst. Diff: ServerEmulator/src/handlers/LoginHandler.ts, ServerEmulator/src/handlers/PacketHandler.ts, ServerEmulator/src/protocol/Constants.ts, ServerEmulator/src/utils/PacketLogger.ts, ServerEmulator/src/reliable/ReliablePackets.ts, ServerEmulator/src/config/ConfigLoader.ts. Rollback: copy "%USERPROFILE%\.codex\backups\LoginHandler.ts-20251231-193614" "C:\FoM_Decompilation\ServerEmulator\src\handlers\LoginHandler.ts"; copy "%USERPROFILE%\.codex\backups\PacketHandler.ts-20251231-193614" "C:\FoM_Decompilation\ServerEmulator\src\handlers\PacketHandler.ts"; copy "%USERPROFILE%\.codex\backups\Constants.ts-20251231-193614" "C:\FoM_Decompilation\ServerEmulator\src\protocol\Constants.ts"; copy "%USERPROFILE%\.codex\backups\PacketLogger.ts-20251231-193614" "C:\FoM_Decompilation\ServerEmulator\src\utils\PacketLogger.ts"; copy "%USERPROFILE%\.codex\backups\ReliablePackets.ts-20251231-193614" "C:\FoM_Decompilation\ServerEmulator\src\reliable\ReliablePackets.ts"; copy "%USERPROFILE%\.codex\backups\ConfigLoader.ts-20251231-193614" "C:\FoM_Decompilation\ServerEmulator\src\config\ConfigLoader.ts". [12/31/25-07:52PM] Ensure master emits 0x7B after 0x6E even if auth already toggled by tracking worldSelectSent per connection. Intended delta: guarantee single 0x7B subId=4 send after auth so client always triggers 0x72. Diff: ServerEmulator/src/handlers/LoginHandler.ts, ServerEmulator/src/network/Connection.ts. Rollback: git checkout -- ServerEmulator/src/handlers/LoginHandler.ts ServerEmulator/src/network/Connection.ts. [12/31/25-08:01PM] Allow 0x72 WORLD_LOGIN to be parsed after auth on master so 0x73 is sent in reliable-inner flow. Intended delta: accept post-auth world login in MasterHandler. Diff: ServerEmulator/src/handlers/MasterHandler.ts. Rollback: git checkout -- ServerEmulator/src/handlers/MasterHandler.ts. [12/31/25-08:01PM] Test: start_server.bat + start_world.bat + start_client.bat (open/login=3) -> saw 0x7B -> 0x72 -> 0x73 in master/client logs; client emulator did not connect to world (no traffic in ServerEmulator/logs/test_world.out.log). [12/31/25-08:11PM] ClientEmulator now auto-connects to world after 0x73 (open connection + 0x72 to world) with a dedicated socket/log connectionId. Intended delta: actually reach world emulator on 0x73. Diff: ClientEmulator/src/tools/TestClient.ts. Rollback: git checkout -- ClientEmulator/src/tools/TestClient.ts. [12/31/25-08:11PM] Test: start_server.bat + start_world.bat + start_client.bat -mode open -login 3 -> world log shows ID_OPEN_CONNECTION_REQUEST + 0x72 from client; client log shows Conn#2 traffic. [01/01/26-09:46PM] Randomize 0x7B playerId per connection when FOM_PLAYER_ID not set (default-on unless FOM_PLAYER_ID_RANDOM=0); gate 0x72 using resolved playerId and store it in connection. Intended delta: prevent playerId mismatch with client shared-mem while preparing a DB-backed id source. Diff: ServerEmulator/src/handlers/LoginHandler.ts, ServerEmulator/src/handlers/PacketHandler.ts, ServerEmulator/src/config/ConfigLoader.ts. Rollback: git checkout -- ServerEmulator/src/handlers/LoginHandler.ts ServerEmulator/src/handlers/PacketHandler.ts ServerEmulator/src/config/ConfigLoader.ts. [01/02/26-12:27AM] Send ID_CONNECTION_REQUEST_ACCEPTED unwrapped when 0x04 arrives inside reliable; client drops reliable-only accept before peer list exists. Intended delta: seed peer list so reliable 0x6D reaches NetMgr. Diff: ServerEmulator/src/handlers/PacketHandler.ts. Rollback: git checkout -- ServerEmulator/src/handlers/PacketHandler.ts. [01/02/26-12:53AM] Align 0x0E format to RakNet 3.5 (15 bytes, LE, no timestamp/placeholder) so client accepts connection. Intended delta: fix connection accept parse and allow peer list seeding. Diff: ServerEmulator/src/handlers/PacketHandler.ts. Rollback: git checkout -- ServerEmulator/src/handlers/PacketHandler.ts. [01/02/26-01:07AM] Revert 0x0E to legacy FoM wrapper format (25-byte payload, BE addr/port + placeholder + timestamp) and send via legacy 0x40 reliable header to restore peer list seeding. Intended delta: match known-working FoM connection accept format while keeping newer handlers intact. Diff: ServerEmulator/src/handlers/PacketHandler.ts. Rollback: git checkout -- ServerEmulator/src/handlers/PacketHandler.ts.

- [ ] [12/28/25-11:02PM] M4 World accept + ID/MessageGroup scaffold
  - Context: Docs\Projects\Emulator.md (Solution Sketch #4)
  - Acceptance: World connection established; client processes ID packet (msg 12) and MessageGroup (msg 14) without disconnect.
  - Validation: FoM stays connected 60s; emulator logs show successful dispatch.
  - Tasks: Accept world password; send ID packet; emit minimal MessageGroup; verify handler dispatch.
  - Dependencies: M2, M3; AddressMap.md message handlers.
  - Status: In progress. [12/31/25-08:54PM] World now parses CMSG_CONNECTSTAGE (0x09) and responds with a stub SMSG_UPDATE spawn; LithTech size-indicator writer added so large submessages decode; TestClient logs NETPROTOCOLVERSION/YOURID/CLIENTOBJECTID. Intended delta: after 0x72, client receives NETPROTOCOLVERSION/YOURID/CLIENTOBJECTID/LOADWORLD, sends stage=0, then server emits a minimal CF_NEWOBJECT update to keep world session alive. Diff: ServerEmulator/src/handlers/PacketHandler.ts, ServerEmulator/src/network/Connection.ts, ServerEmulator/src/protocol/Constants.ts, ClientEmulator/src/tools/TestClient.ts, ClientEmulator/src/protocol/Constants.ts. Rollback: git checkout -- ServerEmulator/src/handlers/PacketHandler.ts ServerEmulator/src/network/Connection.ts ServerEmulator/src/protocol/Constants.ts ClientEmulator/src/tools/TestClient.ts ClientEmulator/src/protocol/Constants.ts. Tests: start_server.bat + start_world.bat + start_client.bat -mode open -login 3 (12/31/25 8:52PM) -> world log shows 0x72 accepted, login burst, 0x09 stage packet, SMSG_UPDATE (98B) sent; client log shows SMSG_LOADWORLD and stable ping/pong over 15s window. [12/31/25-09:09PM] Added world heartbeat sender: emits SMSG_UNGUARANTEEDUPDATE (ID 10) with 0xFFFF terminator + float time after CONNECTSTAGE, on interval; tracks worldTimeOrigin for elapsed time. Intended delta: keep client alive with periodic unguaranteed updates per MMO plan Phase 1. Diff: ServerEmulator/src/handlers/PacketHandler.ts, ServerEmulator/src/index.ts, ServerEmulator/src/network/Connection.ts, ServerEmulator/src/protocol/Constants.ts, ClientEmulator/src/protocol/Constants.ts. Rollback: git checkout -- ServerEmulator/src/handlers/PacketHandler.ts ServerEmulator/src/index.ts ServerEmulator/src/network/Connection.ts ServerEmulator/src/protocol/Constants.ts ClientEmulator/src/protocol/Constants.ts. [12/31/25-09:30PM] Added client-side handler for SMSG_UNGUARANTEEDUPDATE (ID 10) with throttled logging (disabled by default). Intended delta: parse heartbeat packets without spamming logs; enable opt-in logging via env. Diff: ClientEmulator/src/tools/TestClient.ts. Rollback: git checkout -- ClientEmulator/src/tools/TestClient.ts. [01/01/26-09:50PM] Validation (direct terminal, no bats): master sent 0x7B then 0x73 after 0x72; client connected to world and parsed NETPROTOCOLVERSION/YOURID/CLIENTOBJECTID/LOADWORLD; world emitted spawn (98B) and periodic 29B unguaranteed updates; client logs show SMSG_UNGUARANTEEDUPDATE times ticking. Logs: ServerEmulator/logs/validation_master.out.log, ServerEmulator/logs/validation_world.out.log, ClientEmulator/logs/validation_client.out.log.

- [ ] [12/28/25-11:02PM] M5 Minimum world state for character visible
  - Context: Docs\Projects\Emulator.md (Solution Sketch #5)
  - Acceptance: FoM renders character in-world (even with minimal state).
  - Validation: Manual client observation + emulator logs; capture of required packet IDs recorded.
  - Tasks: Identify packet IDs required for render; implement stubs; iterate via capture + IDA.
  - Dependencies: M4; incremental packet decode from CShell handlers.
- Status: In progress. [12/29/25-3:21AM] Decoded Packet_ID_AF/B0/B1/B2 bit layouts + helpers in CShell; updated AddressMap.md; applied IDA renames. [12/29/25-3:32AM] Decoded Packet_ID_MARKET + Packet_ID_PLAYERFILE bit layouts + helpers; updated AddressMap.md; applied IDA renames. [12/29/25-3:37AM] Refined Packet_ID_UPDATE/WeaponFireEntry weapon payload layout (type2/3/4) + terminator; updated AddressMap.md. [12/29/25-04:01AM] Verified items/weapon packet reads (MOVE_ITEMS/USE_ITEM/ITEMS_* /UNLOAD_WEAPON/MERGE/SPLIT/REPAIR/RECYCLE) + ItemStructA/ItemEntryWithId + ItemsAdded payload; applied IDA renames; vtable offsets mapped (+0x14/+0x58/+0x64), no direct fom_client.exe call sites found. [12/29/25-04:11AM] Verified FACTION/SKILLS packet reads + helper layouts in CShell; traced Packet_ID_TRANSFER_ITEMS RTTI (no handler/vtable use); applied IDA renames. [12/29/25-04:23AM] Identified Packet_ID_PLAYER2PLAYER RTTI/vtable; mapped ctor/read/write (ID -86/0xAA); renamed Packet_ID_AA -> Packet_ID_PLAYER2PLAYER; updated AddressMap.md and IDA names. [12/29/25-04:23AM] Mapped Player2Player handler case actions (window IDs + call targets); confirmed Packet_ID_AC opcode tables only handle 501/510/511/512/516; rechecked TRANSFER_ITEMS (no FoM dll/exe hits outside CShell IDB). [12/29/25-04:23AM] Attempted Packet_ID_GROUP in FoM; not present (FoM-only RTTI). Added CWindowMgr_GetWindowById helper and noted FoM-only status; renamed sub_10107540. [12/29/25-04:57AM] Decoded FACTION block_* entry layouts (0D78/0E3C/0FD4/107C/1090/10A0/11A4/1170/1318/1340/1738/1784/17BC) + SKILLS list details; confirmed ReadBitsCompressed algorithm; renamed Read_u8c/ReadBits_2048/Read_u32c_alt/BitStream_ReadBit_u8. [12/29/25-04:57AM] Completed FACTION subtype case map details for types 64/65 (u32c @+0x1074). [12/29/25-05:08AM] Completed Packet_ID_A6 subtype map; extended Packet_ID_A9 types 21-23 + default cases; added u64c helper; renamed Read_u64c/Write_u64c. [12/29/25-05:08AM] Drafted gameplay packet structs in Docs/Notes/CShell_Gameplay_Packets.md. [12/29/25-05:08AM] Re-scanned FoM/FoM binaries for Packet_ID_GROUP/TRANSFER_ITEMS strings; no matches beyond existing CShell RTTI. [12/29/25-05:08AM] Renamed Packet_ID_A5/A6/A8 read functions in CShell IDB. [12/29/25-05:17AM] Added FACTION/SKILLS struct drafts + TRANSFER_ITEMS status to Docs/Notes/CShell_Gameplay_Packets.md; verified RTTI-only refs for TRANSFER_ITEMS (TypeDescriptor -> COL -> vftable list). [12/29/25-05:25AM] Added PLAYERFILE/PLAYER2PLAYER/AC/AF/B0/B1/B2/Friends/Storage/Mining/Production/Market packet layouts to Docs/Notes/CShell_Gameplay_Packets.md. [12/29/25-05:35AM] Added remaining item/inventory + weapon packet layouts (MOVE_ITEMS/ITEMS_* /USE_ITEM/UNLOAD_WEAPON/MERGE/SPLIT/REPAIR/RECYCLE/NAME_CHANGE/BACKPACK_CONTENTS/MAIL/WEAPONFIRE/RELOAD/UPDATE) to CShell gameplay packet draft. [12/29/25-05:41AM] Expanded MAIL entries and WeaponFireEntry (types 1-4) to bit-level order in CShell gameplay packet draft. [12/29/25-05:48AM] Refined FACTION helper block layouts (0D78/0E08/0E2C/0E3C/107C/1090/10A0/1160/1170/11A4/1318/1340/1738/1784/17BC) + ListB/ListC details; added A5_Struct2 and corrected Block_0E08 order in CShell gameplay packet draft. [12/29/25-06:14AM] Decompiled PLAYERFILE/PLAYER2PLAYER/AC/MARKET/ITEMS/USE_ITEM/UNLOAD_WEAPON/WEAPONFIRE reads; updated AddressMap.md evidence; renamed AF/B0/B1/B2/BACKPACK/MAIL read funcs in CShell IDB; decomp failed for AF/B0/B1/B2/UPDATE/BACKPACK/MAIL (kept disasm). [12/29/25-06:31AM] Decompiled AF/B0/B1/B2/UPDATE/BACKPACK/MAIL reads; decompiled Packet_ID_B5/B6 read + entry/list/struct helpers; corrected AF/B1/B5/B6 type maps; updated AddressMap.md evidence and CShell gameplay packet draft; applied IDA renames. [12/29/25-06:39AM] Decompiled Packet_ID_MAIL_read_entry + B5 extra list/map helpers; added B5 extra list + entry2 map layouts; updated AddressMap.md and CShell gameplay packet draft; renamed new helpers in CShell IDB; bitstream order cross-check vs HookInjector MSB routines. [12/29/25-06:42AM] Finished Mail: decompiled Packet_ID_MAIL_entry_list_insert (0x1013DC60), added entry size (0x848) + list insert behavior, updated AddressMap.md and CShell gameplay packet draft, renamed mail list helper in IDA. [12/29/25-06:49AM] Completed mail send path: decompiled Packet_ID_MAIL_write + write_entry/write_entries/write_idlist; identified entry fill + list dedupe helpers; updated AddressMap.md and CShell gameplay packet draft; renamed mail write helpers in IDA. [12/29/25-06:56AM] Decompiled PRODUCTION/STORAGE/MINING/FRIENDS + item packets (merge/split/repair/name change/item removed); updated AddressMap.md evidence and Storage/Mailing helpers; renamed new helpers in IDA; updated CShell gameplay packet draft (storage/mining/friends notes). [12/29/25-07:01AM] Decompiled Storage type-9 sub-blocks (12/3/6 ItemEntryWithId lists); decompiled A5/A6/A8/A9 reads; corrected A6/A9 type maps; updated AddressMap.md + CShell gameplay packet draft; renamed storage block helpers in IDA. [12/29/25-07:05AM] Decompiled CWindowSendMail_OnCommand (0x1013DE40) and LTClient_SendPacket_BuildIfNeeded (0x1018D9C0); documented send-mail validation rules + send args; updated AddressMap.md and CShell gameplay packet draft; renamed send mail handler + send helper in IDA. [12/29/25-07:08AM] Marked FACTION/SKILLS read lines as decomp in AddressMap.md. [12/29/25-07:14AM] Decompiled Packet_ID_A9 helpers (structA/B/C/C2/C3/D + sublists + list); updated AddressMap.md evidence. [12/29/25-07:17AM] Decompiled WeaponFireEntry_write + WeaponFireEntry_type1_write + Packet_ID_UPDATE_write; updated AddressMap.md evidence and clarified type1 optional u32 is non-compressed in gameplay packet draft. [12/29/25-07:17AM] Renamed Read_u32 -> Write_u32_raw in CShell IDB; updated gameplay packet draft note. [12/29/25-07:39AM] PAUSE NOTE: MCP server on port 13338 is down; disasm of WeaponFireEntry_type2/3/4_write blocked. Next: restart MCP in IDA, disasm 0x101A00B0/0x101A0360/0x101A04D0 to finalize WeaponFireEntry payload bits, then begin semantic xref naming for A5/A6/A8/AC/AF/B0/B1/B2/B5/B6. [12/30/25-12:53AM] Mapped LithTech message handler table in fom_client (g_MessageHandlers, ID 12/14 handlers) + corrected RakNet encryption key address/connectMode offsets; added DataBlockEncryptor set/unset + syn-cookie RNG; updated AddressMap.md + RakNet_LithTech_DeepDive.md; applied IDA renames in fom_client/CShell. Intended delta: make FoM handler table + RakNet security offsets explicit for emulator and packet parsing. Diff: AddressMap.md, RakNet_LithTech_DeepDive.md, Client/fom_client.exe.i64, Client/Resources/CShell.dll.i64. Rollback: git checkout -- AddressMap.md RakNet_LithTech_DeepDive.md Client/fom_client.exe.i64 Client/Resources/CShell.dll.i64



