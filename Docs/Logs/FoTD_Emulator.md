# FoTD Emulator Log

- [ ] [12/28/25-11:02PM] M1 Transport capture + decision
  - Context: Docs\Specs\FoTD_Emulator.md (Solution Sketch #1)
  - Acceptance: First login packets captured and transport path confirmed (RakNet vs CUDPDriver).
  - Validation: PCAP + summary attached; decision recorded (magic 0x9919D9C7 vs RakNet IDs).
  - Dependencies: FoTD client runnable; SharkMCP (Wireshark/tshark MCP) or emulator logging.
  - Status: Not started.

- [ ] [12/28/25-11:02PM] M2 Protocol framing alignment (BitStream + constants)
  - Context: Docs\Specs\FoTD_Emulator.md (Inputs / Facts, Solution Sketch #2)
  - Acceptance: Bit order is MSB-first, compressed ints match FoTD, default port aligns with FoTD capture.
  - Validation: Unit decode of captured packet; emulator logs show correct parsing with no bit overruns.
  - Tasks: Update BitStream order + endian; implement FoTD compressed ints; fix constants and header parsing.
  - Dependencies: M1 decision; AddressMap_FoTD.md bitstream section.
  - Status: Not started.

- [ ] [12/28/25-11:02PM] M3 Master login path (LOGIN_REQUEST -> 0x6D)
  - Context: Docs\Specs\FoTD_Emulator.md (Solution Sketch #3)
  - Acceptance: LOGIN_REQUEST parsed from capture; LOGIN_REQUEST_RETURN sent and ACKed.
  - Validation: Emulator logs show login success; client proceeds to world connect; ACK observed.
  - Tasks: Identify LOGIN_REQUEST layout; implement parser; build 0x6D response with world IP/port.
  - Dependencies: M1, M2; capture data for LOGIN_REQUEST layout.
  - Status: In progress. [12/29/25-04:12PM] Added MSB-first bitstream decode + 0x6D login decoder in HookInjector with optional MSB bit dump; added offline log decoder script to parse fom_hook.log. Intended delta: capture/inspect exact 0x6D payload + status + raw 2048-bit string region from client. Diff: HookInjector/fom_hook.cpp, Scripts/decode_6d_from_log.py. Rollback: git checkout -- HookInjector/fom_hook.cpp Scripts/decode_6d_from_log.py

- [ ] [12/28/25-11:02PM] M4 World accept + ID/MessageGroup scaffold
  - Context: Docs\Specs\FoTD_Emulator.md (Solution Sketch #4)
  - Acceptance: World connection established; client processes ID packet (msg 12) and MessageGroup (msg 14) without disconnect.
  - Validation: Client stays connected 60s; emulator logs show successful dispatch.
  - Tasks: Accept world password; send ID packet; emit minimal MessageGroup; verify handler dispatch.
  - Dependencies: M2, M3; AddressMap_FoTD.md message handlers.
  - Status: Not started.

- [ ] [12/28/25-11:02PM] M5 Minimum world state for character visible
  - Context: Docs\Specs\FoTD_Emulator.md (Solution Sketch #5)
  - Acceptance: Client renders character in-world (even with minimal state).
  - Validation: Manual client observation + emulator logs; capture of required packet IDs recorded.
  - Tasks: Identify packet IDs required for render; implement stubs; iterate via capture + IDA.
  - Dependencies: M4; incremental packet decode from CShell handlers.
- Status: In progress. [12/29/25-3:21AM] Decoded Packet_ID_AF/B0/B1/B2 bit layouts + helpers in CShell; updated AddressMap_FoTD.md; applied IDA renames. [12/29/25-3:32AM] Decoded Packet_ID_MARKET + Packet_ID_PLAYERFILE bit layouts + helpers; updated AddressMap_FoTD.md; applied IDA renames. [12/29/25-3:37AM] Refined Packet_ID_UPDATE/WeaponFireEntry weapon payload layout (type2/3/4) + terminator; updated AddressMap_FoTD.md. [12/29/25-04:01AM] Verified items/weapon packet reads (MOVE_ITEMS/USE_ITEM/ITEMS_* /UNLOAD_WEAPON/MERGE/SPLIT/REPAIR/RECYCLE) + ItemStructA/ItemEntryWithId + ItemsAdded payload; applied IDA renames; vtable offsets mapped (+0x14/+0x58/+0x64), no direct fom_client.exe call sites found. [12/29/25-04:11AM] Verified FACTION/SKILLS packet reads + helper layouts in CShell; traced Packet_ID_TRANSFER_ITEMS RTTI (no handler/vtable use); applied IDA renames. [12/29/25-04:23AM] Identified Packet_ID_PLAYER2PLAYER RTTI/vtable; mapped ctor/read/write (ID -86/0xAA); renamed Packet_ID_AA -> Packet_ID_PLAYER2PLAYER; updated AddressMap_FoTD.md and IDA names. [12/29/25-04:23AM] Mapped Player2Player handler case actions (window IDs + call targets); confirmed Packet_ID_AC opcode tables only handle 501/510/511/512/516; rechecked TRANSFER_ITEMS (no FoTD/FoM dll/exe hits outside CShell IDB). [12/29/25-04:23AM] Attempted Packet_ID_GROUP in FoTD; not present (FoM-only RTTI). Added CWindowMgr_GetWindowById helper and noted FoM-only status; renamed sub_10107540. [12/29/25-04:57AM] Decoded FACTION block_* entry layouts (0D78/0E3C/0FD4/107C/1090/10A0/11A4/1170/1318/1340/1738/1784/17BC) + SKILLS list details; confirmed ReadBitsCompressed algorithm; renamed Read_u8c/ReadBits_2048/Read_u32c_alt/BitStream_ReadBit_u8. [12/29/25-04:57AM] Completed FACTION subtype case map details for types 64/65 (u32c @+0x1074). [12/29/25-05:08AM] Completed Packet_ID_A6 subtype map; extended Packet_ID_A9 types 21-23 + default cases; added u64c helper; renamed Read_u64c/Write_u64c. [12/29/25-05:08AM] Drafted gameplay packet structs in Docs/Protocol/packets/CShell_Gameplay_Packets.md. [12/29/25-05:08AM] Re-scanned FoM/FoTD binaries for Packet_ID_GROUP/TRANSFER_ITEMS strings; no matches beyond existing CShell RTTI. [12/29/25-05:08AM] Renamed Packet_ID_A5/A6/A8 read functions in CShell IDB. [12/29/25-05:17AM] Added FACTION/SKILLS struct drafts + TRANSFER_ITEMS status to Docs/Protocol/packets/CShell_Gameplay_Packets.md; verified RTTI-only refs for TRANSFER_ITEMS (TypeDescriptor -> COL -> vftable list). [12/29/25-05:25AM] Added PLAYERFILE/PLAYER2PLAYER/AC/AF/B0/B1/B2/Friends/Storage/Mining/Production/Market packet layouts to Docs/Protocol/packets/CShell_Gameplay_Packets.md. [12/29/25-05:35AM] Added remaining item/inventory + weapon packet layouts (MOVE_ITEMS/ITEMS_* /USE_ITEM/UNLOAD_WEAPON/MERGE/SPLIT/REPAIR/RECYCLE/NAME_CHANGE/BACKPACK_CONTENTS/MAIL/WEAPONFIRE/RELOAD/UPDATE) to CShell gameplay packet draft. [12/29/25-05:41AM] Expanded MAIL entries and WeaponFireEntry (types 1-4) to bit-level order in CShell gameplay packet draft. [12/29/25-05:48AM] Refined FACTION helper block layouts (0D78/0E08/0E2C/0E3C/107C/1090/10A0/1160/1170/11A4/1318/1340/1738/1784/17BC) + ListB/ListC details; added A5_Struct2 and corrected Block_0E08 order in CShell gameplay packet draft. [12/29/25-06:14AM] Decompiled PLAYERFILE/PLAYER2PLAYER/AC/MARKET/ITEMS/USE_ITEM/UNLOAD_WEAPON/WEAPONFIRE reads; updated AddressMap_FoTD.md evidence; renamed AF/B0/B1/B2/BACKPACK/MAIL read funcs in CShell IDB; decomp failed for AF/B0/B1/B2/UPDATE/BACKPACK/MAIL (kept disasm). [12/29/25-06:31AM] Decompiled AF/B0/B1/B2/UPDATE/BACKPACK/MAIL reads; decompiled Packet_ID_B5/B6 read + entry/list/struct helpers; corrected AF/B1/B5/B6 type maps; updated AddressMap_FoTD.md evidence and CShell gameplay packet draft; applied IDA renames. [12/29/25-06:39AM] Decompiled Packet_ID_MAIL_read_entry + B5 extra list/map helpers; added B5 extra list + entry2 map layouts; updated AddressMap_FoTD.md and CShell gameplay packet draft; renamed new helpers in CShell IDB; bitstream order cross-check vs HookInjector MSB routines. [12/29/25-06:42AM] Finished Mail: decompiled Packet_ID_MAIL_entry_list_insert (0x1013DC60), added entry size (0x848) + list insert behavior, updated AddressMap_FoTD.md and CShell gameplay packet draft, renamed mail list helper in IDA. [12/29/25-06:49AM] Completed mail send path: decompiled Packet_ID_MAIL_write + write_entry/write_entries/write_idlist; identified entry fill + list dedupe helpers; updated AddressMap_FoTD.md and CShell gameplay packet draft; renamed mail write helpers in IDA. [12/29/25-06:56AM] Decompiled PRODUCTION/STORAGE/MINING/FRIENDS + item packets (merge/split/repair/name change/item removed); updated AddressMap_FoTD.md evidence and Storage/Mailing helpers; renamed new helpers in IDA; updated CShell gameplay packet draft (storage/mining/friends notes). [12/29/25-07:01AM] Decompiled Storage type-9 sub-blocks (12/3/6 ItemEntryWithId lists); decompiled A5/A6/A8/A9 reads; corrected A6/A9 type maps; updated AddressMap_FoTD.md + CShell gameplay packet draft; renamed storage block helpers in IDA. [12/29/25-07:05AM] Decompiled CWindowSendMail_OnCommand (0x1013DE40) and LTClient_SendPacket_BuildIfNeeded (0x1018D9C0); documented send-mail validation rules + send args; updated AddressMap_FoTD.md and CShell gameplay packet draft; renamed send mail handler + send helper in IDA. [12/29/25-07:08AM] Marked FACTION/SKILLS read lines as decomp in AddressMap_FoTD.md. [12/29/25-07:14AM] Decompiled Packet_ID_A9 helpers (structA/B/C/C2/C3/D + sublists + list); updated AddressMap_FoTD.md evidence. [12/29/25-07:17AM] Decompiled WeaponFireEntry_write + WeaponFireEntry_type1_write + Packet_ID_UPDATE_write; updated AddressMap_FoTD.md evidence and clarified type1 optional u32 is non-compressed in gameplay packet draft. [12/29/25-07:17AM] Renamed Read_u32 -> Write_u32_raw in CShell IDB; updated gameplay packet draft note. [12/29/25-07:39AM] PAUSE NOTE: MCP server on port 13338 is down; disasm of WeaponFireEntry_type2/3/4_write blocked. Next: restart MCP in IDA, disasm 0x101A00B0/0x101A0360/0x101A04D0 to finalize WeaponFireEntry payload bits, then begin semantic xref naming for A5/A6/A8/AC/AF/B0/B1/B2/B5/B6.
